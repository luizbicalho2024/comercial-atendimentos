<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/streamlit-component-lib/1.3.0/streamlit.js"></script>
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: sans-serif; background-color: transparent;}
        button { background-color: #0052cc; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-size: 16px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button:disabled { background-color: #99bbff; cursor: not-allowed; box-shadow: none; }
        button:active { transform: translateY(2px); box-shadow: none; }
        #msg { font-size: 14px; margin-top: 12px; text-align: center; font-weight: 600; padding: 0 10px; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
    </style>
</head>
<body>
    <button id="btn">üìç Capturar Localiza√ß√£o Exata</button>
    <div id="msg"></div>
    <script>
        function init() { Streamlit.setFrameHeight(100); }
        Streamlit.events.addEventListener(Streamlit.RENDER_EVENT, init);
        Streamlit.setComponentReady();

        document.getElementById('btn').addEventListener('click', function() {
            const btn = document.getElementById('btn');
            const msg = document.getElementById('msg');
            btn.innerText = "‚è≥ Buscando sat√©lite...";
            btn.disabled = true;
            msg.className = "";
            msg.innerText = "";
            
            if (!navigator.geolocation) {
                msg.innerText = "Navegador n√£o suporta GPS.";
                msg.className = "error";
                btn.innerText = "üìç Tentar Novamente";
                btn.disabled = false;
                return;
            }

            // Exige alta precis√£o do hardware
            const options = { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const acc = position.coords.accuracy;
                    // Trava de 150 metros de erro m√°ximo
                    if (acc > 150) { 
                        msg.innerText = "Sinal fraco (Erro: " + Math.round(acc) + "m). V√° para um local aberto (rua) e tente de novo.";
                        msg.className = "error";
                        btn.innerText = "üìç Tentar Novamente";
                        btn.disabled = false;
                        Streamlit.setComponentValue(null);
                    } else {
                        msg.innerText = "‚úÖ GPS Exato (Margem: " + Math.round(acc) + "m).";
                        msg.className = "success";
                        btn.innerText = "Localiza√ß√£o Capturada";
                        Streamlit.setComponentValue({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: acc
                        });
                    }
                },
                function(error) {
                    let err_txt = "Erro ao buscar GPS.";
                    if(error.code == 1) err_txt = "Permiss√£o de localiza√ß√£o negada.";
                    if(error.code == 2) err_txt = "Sinal de sat√©lite indispon√≠vel.";
                    if(error.code == 3) err_txt = "Tempo esgotado. Verifique a internet/sinal.";
                    msg.innerText = err_txt;
                    msg.className = "error";
                    btn.innerText = "üìç Tentar Novamente";
                    btn.disabled = false;
                    Streamlit.setComponentValue(null);
                },
                options
            );
        });
    </script>
</body>
</html>
